<!DOCTYPE html>
<html lang="en">
<head>
    <title>Hello, multi marker globe!</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Monospace;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #loading { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            font-family: sans-serif; 
            text-align: center;
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>

<body>
    <div id="loading">Loading Libraries...</div>

    <!-- Import map for Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://threejs.org/build/three.module.js"
        }
    }</script>

    <!-- 
      This single script block handles everything:
      1. Imports Three.js and makes it global for legacy scripts.
      2. Sequentially loads all required AR.js libraries from a reliable CDN.
      3. Once loading is complete, it runs the main application logic.
    -->
    <script type="module">
        import * as THREE from 'three';
        window.THREE = THREE; // Make THREE global for legacy AR.js scripts

        // --- SCRIPT LOADING ---
        const legacyScripts = [
            "https://raw.githack.com/loksangho/loksangho.github.io/gh-pages/multi-marker-mug-shot/jsartoolkit/artoolkit.min.js",
            "https://raw.githack.com/loksangho/loksangho.github.io/gh-pages/multi-marker-mug-shot/jsartoolkit/artoolkit.api.js",
            //"https://arprojectsdemo.netlify.app/jsartoolkit5/artoolkit.api.js",
            //"https://arprojectsdemo.netlify.app/jsartoolkit5/artoolkit.min.js",
            "threex/threex-artoolkitsource.js",
            "threex/threex-artoolkitcontext.js",
            "threex/threex-arbasecontrols.js",
            "threex/threex-armarkercontrols.js"
        ];

        function loadNextScript() {
            if (legacyScripts.length === 0) {
                console.log("All AR.js libraries loaded successfully.");
                document.getElementById('loading').style.display = 'none';
                // **FIXED**: Run the main application logic ONLY after all scripts are loaded.
                main();
                return;
            }

            const nextScriptSrc = legacyScripts.shift();
            console.log(`Loading: ${nextScriptSrc}`);
            const script = document.createElement('script');
            script.src = nextScriptSrc;
            script.onload = loadNextScript;
            script.onerror = () => console.error(`Failed to load script: ${nextScriptSrc}`);
            document.head.appendChild(script);
        }

        // Start the loading process
        loadNextScript();


        // --- MAIN APPLICATION LOGIC ---
        function main() {
            var scene, camera, renderer, clock, deltaTime, totalTime;
            var arToolkitSource, arToolkitContext;
            var markerNames, markerArray, currentMarkerName;
            var sceneGroup;
            var globe;

            initialize();
            animate();

            function initialize() {
                scene = new THREE.Scene();

                let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
                scene.add(ambientLight);

                camera = new THREE.Camera();
                scene.add(camera);

                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });
                renderer.setClearColor(new THREE.Color('lightgrey'), 0);
                // **FIXED**: Make renderer full screen
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.domElement.style.position = 'absolute';
                renderer.domElement.style.top = '0px';
                renderer.domElement.style.left = '0px';
                document.body.appendChild(renderer.domElement);

                clock = new THREE.Clock();
                deltaTime = 0;
                totalTime = 0;

                // --- setup arToolkitSource ---
                arToolkitSource = new THREEx.ArToolkitSource({
                    sourceType: 'webcam',
                });

                arToolkitSource.init(function onReady() {
                    onResize();
                });

                // handle resize event
                window.addEventListener('resize', onResize);

                // --- setup arToolkitContext ---
                arToolkitContext = new THREEx.ArToolkitContext({
                    // **FIXED**: Use full URL for camera parameters
                    cameraParametersUrl: 'https://raw.githack.com/jeromeetienne/AR.js/master/data/data/camera_para.dat',
                    detectionMode: 'mono',
                });

                arToolkitContext.init(function onCompleted() {
                    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                });

                // --- setup markerRoots ---
                markerNames = ["hiro", "kanji", "letterA"];
                markerArray = [];

                for (let i = 0; i < markerNames.length; i++) {
                    let marker = new THREE.Group();
                    scene.add(marker);
                    markerArray.push(marker);

                    let markerControls = new THREEx.ArMarkerControls(arToolkitContext, marker, {
                        type: 'pattern',
                        // **FIXED**: Use full URL for marker patterns
                        patternUrl: "https://raw.githack.com/jeromeetienne/AR.js/master/data/data/patt." + markerNames[i],
                    });

                    let markerGroup = new THREE.Group();
                    marker.add(markerGroup);
                }

                // --- setup scene ---
                sceneGroup = new THREE.Group();

                let loader = new THREE.TextureLoader();
                let texture = loader.load('https://stemkoski.github.io/Three.js/images/earth-sphere.jpg');
                let geometry1 = new THREE.SphereGeometry(1, 32, 32);
                let material1 = new THREE.MeshLambertMaterial({
                    map: texture,
                    opacity: 0.9
                });
                globe = new THREE.Mesh(geometry1, material1);
                globe.position.y = 1;
                sceneGroup.add(globe);

                markerArray[0].children[0].add(sceneGroup);
                currentMarkerName = markerNames[0];

                let pointLight = new THREE.PointLight(0xffffff, 1, 50);
                camera.add(pointLight);
            }

            function onResize() {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
                }
                // **FIXED**: Update camera aspect ratio on resize
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function update() {
                if (arToolkitSource.ready !== false) {
                    arToolkitContext.update(arToolkitSource.domElement);
                }

                globe.rotation.y += 0.01;

                let anyMarkerVisible = false;
                for (let i = 0; i < markerArray.length; i++) {
                    if (markerArray[i].visible) {
                        anyMarkerVisible = true;
                        markerArray[i].children[0].add(sceneGroup);
                        if (currentMarkerName != markerNames[i]) {
                            currentMarkerName = markerNames[i];
                        }

                        let p = new THREE.Vector3();
                        let q = new THREE.Quaternion();
                        let s = new THREE.Vector3();
                        markerArray[i].children[0].getWorldPosition(p);
                        markerArray[i].children[0].getWorldQuaternion(q);
                        markerArray[i].children[0].getWorldScale(s);
                        
                        let lerpAmount = 0.5;
                        scene.add(sceneGroup);
                        sceneGroup.position.lerp(p, lerpAmount);
                        sceneGroup.quaternion.slerp(q, lerpAmount);
                        sceneGroup.scale.lerp(s, lerpAmount);

                        break;
                    }
                }
            }

            function render() {
                renderer.render(scene, camera);
            }

            function animate() {
                requestAnimationFrame(animate);
                deltaTime = clock.getDelta();
                totalTime += deltaTime;
                update();
                render();
            }
        }
    </script>
</body>
</html>
